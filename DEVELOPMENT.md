# Development Guide

This document outlines the step-by-step process for adding new methods to the AnkiDroid API plugin.

## Architecture Overview

The plugin architecture consists of several layers:

1. **Kotlin Android Plugin** (`packages/tauri-plugin-ankidroid-api/android/src/main/java/app/tauri/ankidroid/AnkiDroidApiPlugin.kt`)
   - Contains the actual implementation using AnkiDroid's ContentProvider API
   - Uses `@Command` decorators to expose methods to Tauri

2. **Rust Plugin** (`packages/tauri-plugin-ankidroid-api/src/lib.rs`)
   - Minimal wrapper that registers the Android plugin
   - Handles permissions and command registration

3. **TypeScript Client Library** (`packages/ankidroid-api-client/`)
   - Provides typed interface for frontend applications
   - Handles schema validation and error handling

4. **Tauri App** (`packages/tauri-app/`)
   - Example application demonstrating the plugin
   - Contains React UI components and end-to-end tests

## Adding a New Method: Step-by-Step Process

### Step 1: Implement the Android/Kotlin Method

File: `packages/tauri-plugin-ankidroid-api/android/src/main/java/app/tauri/ankidroid/AnkiDroidApiPlugin.kt`

1. **Add the Data Class (if needed):**
   ```kotlin
   data class DeleteModelArgs(
       val modelId: Long
   )
   ```

2. **Add the Command Method:**
   ```kotlin
   @Command
   fun deleteModel(invoke: Invoke) {
       CoroutineScope(Dispatchers.IO).launch {
           try {
               val args = invoke.parseArgs(DeleteModelArgs::class.java)
               
               // Your implementation here
               val success = performDeleteModel(args.modelId)
               
               val result = mapOf(
                   "success" to success,
                   "message" to if (success) "Model deleted" else "Failed to delete model"
               )
               
               invoke.resolve(JSObject().apply {
                   put("success", success)
                   put("message", result["message"])
               })
           } catch (e: Exception) {
               invoke.reject("Failed to delete model: ${e.message}")
           }
       }
   }
   ```

### Step 2: Register the Command in Rust Build Script

File: `packages/tauri-plugin-ankidroid-api/build.rs`

Add the new command to the `COMMANDS` array:

```rust
const COMMANDS: &[&str] = &[
    "isAnkiDroidAvailable",
    "checkPermission",
    "requestPermission",
    "getNotes",
    "createNote",
    "updateNote", 
    "deleteNote",
    "getModels",
    "createModel",
    "deleteModel",  // ← Add your new command here
    "getDecks",
    // ... other commands
];
```

**Important:** This step generates the permission files automatically in `permissions/autogenerated/commands/` when the plugin is built.

### Step 3: Add Request/Response Schemas

File: `packages/ankidroid-api-client/src/schema.ts`

Add Zod schemas for request and response validation:

```typescript
export const DeleteModelRequestSchema = z.object({
  modelId: z.number().int(),
});

export const DeleteModelResponseSchema = z.object({
  success: z.boolean(),
  deletedRows: z.number().int().optional(),
  message: z.string().optional(), 
  error: z.string().optional(),
});
```

### Step 4: Add TypeScript Types

File: `packages/ankidroid-api-client/src/types.ts`

1. **Add imports:**
   ```typescript
   import { 
     // ... existing imports
     DeleteModelRequestSchema,
     DeleteModelResponseSchema,
   } from "./schema";
   ```

2. **Add type exports:**
   ```typescript
   export type DeleteModelRequest = z.infer<typeof DeleteModelRequestSchema>;
   export type DeleteModelResponse = z.infer<typeof DeleteModelResponseSchema>;
   ```

### Step 5: Implement Client Library Function

File: `packages/ankidroid-api-client/src/index.ts`

1. **Add imports:**
   ```typescript
   import {
     // ... existing imports
     deleteModel,
     type DeleteModelRequest,
     type DeleteModelResponse,
   } from "ankidroid-api-client";
   ```

2. **Add the function:**
   ```typescript
   export async function deleteModel(
     request: DeleteModelRequest
   ): Promise<DeleteModelResponse> {
     try {
       const raw = await invoke("plugin:ankidroid-api|deleteModel", request);
       const response = DeleteModelResponseSchema.parse(raw);
       
       // Check if the response indicates an error
       if (!response.success && response.error) {
         throw new Error(response.error);
       }
       
       return response;
     } catch (error) {
       // Error handling logic
       if (error instanceof Error) {
         throw error;
       }
       
       let errorMessage = "Unknown error";
       if (typeof error === "object" && error !== null) {
         const errorObj = error as any;
         if (errorObj.error) {
           errorMessage = errorObj.error;
         } else {
           errorMessage = JSON.stringify(error);
         }
       } else if (typeof error === "string") {
         errorMessage = error;
       }
       
       throw new Error(`Failed to delete model: ${errorMessage}`);
     }
   }
   ```

3. **Add to exports:**
   ```typescript
   export type {
     // ... existing exports
     DeleteModelRequest,
     DeleteModelResponse,
   } from "./types";
   ```

### Step 6: Add Tauri Permissions

File: `packages/tauri-app/src-tauri/capabilities/default.json`

Add the permission to the app's capabilities:

```json
{
  "permissions": [
    "core:default",
    "ankidroid-api:allow-isAnkiDroidAvailable",
    "ankidroid-api:allow-checkPermission", 
    "ankidroid-api:allow-requestPermission",
    "ankidroid-api:allow-getNotes",
    "ankidroid-api:allow-getModels",
    "ankidroid-api:allow-createModel",
    "ankidroid-api:allow-deleteModel",  // ← Add permission here
    // ... other permissions
  ]
}
```

### Step 7: Rebuild Client Library

```bash
cd packages/ankidroid-api-client && npm run build
```

### Step 8: Update UI Components (if needed)

Example for adding delete functionality:

File: `packages/tauri-app/src/components/ModelManager.tsx`

```typescript
import {
  // ... existing imports
  deleteModel,
  type DeleteModelRequest,
  type DeleteModelResponse,
} from "ankidroid-api-client";

// Add state for deletion
const [deleting, setDeleting] = useState<number | null>(null);

// Add delete handler
const handleDeleteModel = async (model: Model) => {
  try {
    setDeleting(model.id);
    const result = await deleteModel({ modelId: model.id });
    
    if (result.success) {
      await fetchModels(); // Refresh list
      setSuccess(`Model "${model.name}" deleted successfully!`);
    } else {
      const errorMsg = result.error || "Failed to delete model";
      addError(errorMsg);
    }
  } catch (error) {
    const errorMsg = error instanceof Error 
      ? error.message 
      : typeof error === 'object' && error !== null
        ? JSON.stringify(error)
        : String(error);
    addError(`Error deleting model: ${errorMsg}`);
  } finally {
    setDeleting(null);
  }
};
```

### Step 9: Add End-to-End Tests

File: `packages/tauri-app/tests/e2e/model-crud.spec.ts`

```typescript
test("should delete a model", async ({}) => {
  // Create a test model first
  const timestamp = Date.now();
  const modelName = `DeleteTestModel_${timestamp}`;
  
  // Create model
  await page.locator("input[placeholder*='Basic']").fill(modelName);
  await page.locator("button", { hasText: "Create Model" }).click();
  await page.waitForSelector("text=Model created successfully!");
  
  // Delete model
  const deleteButton = page.locator(`[data-testid="delete-${modelName}"]`);
  await deleteButton.click();
  
  // Confirm deletion
  await page.locator("button", { hasText: "Delete" }).click();
  
  // Verify success
  await page.waitForSelector(`text=Model "${modelName}" deleted successfully!`);
  await expect(page.locator(`text=${modelName}`)).not.toBeVisible();
});
```

### Step 10: Build and Test

1. **Clean build caches:**
   ```bash
   cd packages/tauri-app/src-tauri && cargo clean
   cd packages/ankidroid-api-client && npm run build
   ```

2. **Start Android development:**
   ```bash
   cd packages/tauri-app && npm run dev:android
   ```

3. **Run tests:**
   ```bash
   cd packages/tauri-app && npm run test
   ```

## Common Issues and Troubleshooting

### Permission Not Found Error

**Error:** `Permission ankidroid-api:allow-deleteModel not found`

**Solution:** 
1. Verify the command is added to `build.rs` COMMANDS array
2. Clean and rebuild the plugin: `cd packages/tauri-plugin-ankidroid-api && cargo clean`
3. The permission files are autogenerated during build

### Command Not Found Error  

**Error:** `ankidroid-api.deleteModel not allowed. Command not found`

**Solution:**
1. Ensure the command is added to Tauri app capabilities in `default.json`
2. Rebuild the Tauri app: `cd packages/tauri-app/src-tauri && cargo clean`

### TypeScript Build Errors

**Error:** Import/export not found

**Solution:**
1. Verify all imports are added to `schema.ts`, `types.ts`, and `index.ts`
2. Rebuild client library: `cd packages/ankidroid-api-client && npm run build`
3. Check import/export consistency across files

### Android Plugin Issues

**Error:** Kotlin compilation errors or missing methods

**Solution:**
1. Verify the `@Command` decorator is present
2. Check that data classes match the schema
3. Ensure proper error handling in the Kotlin implementation
4. Clean Android build: `cd packages/tauri-app && rm -rf src-tauri/target`

## Best Practices

### Error Handling
- Always wrap ContentProvider operations in try-catch blocks
- Provide meaningful error messages to the client
- Use consistent error response format across all methods

### Data Validation
- Use Zod schemas for all request/response validation
- Validate input parameters in Kotlin before ContentProvider operations
- Handle edge cases (empty results, invalid IDs, etc.)

### Performance
- Use background threads (CoroutineScope) for ContentProvider operations
- Implement pagination for large datasets
- Cache frequently accessed data when appropriate

### Testing
- Write comprehensive end-to-end tests for all new functionality
- Test error scenarios and edge cases
- Verify UI integration works correctly

### Documentation
- Update this development guide when adding new patterns
- Document any AnkiDroid API limitations or quirks discovered
- Add JSDoc comments to TypeScript client functions